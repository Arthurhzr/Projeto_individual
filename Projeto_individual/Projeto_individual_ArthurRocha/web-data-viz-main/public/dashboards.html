<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pontuações</title>
    <link rel="stylesheet" href="css/stylegeral.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/sessao.js" ></script>
    <script src="./../js/alerta.js"></script>
</head>
<body onload="validarSessao()" class="body_dash">

    <header>
        <div class="container">
            <div class="logo">
                <a href=""><img src="imagens/X_All-Logo.png" class="imagemLogo"></a>
            </div>
            <div class="menu">
                <nav>
                    <ul>
                        <li><a href="index.html"><b>Página Inicial</b></a></li>
                        <li class="agora"><a><b>Pontuações</b></a></li>
                        <li><a href="login.html"><b>Entrar</b></a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div id="div_conteudo_dash" class="div_conteudo2">

        <div id="div_centro" class="centro_dash">
            <div id="btn_sair" class="sair"><img class="seta" src="imagens/logoff.png" alt=""> <b>Sair</b></div>
            <h1>Bem vindo as estatísticas do quiz!</h1> <h1>Aqui você pode ver acertos e erros tanto individuais como gerais</h1>

            <div id="div_individual" class="pnts_individuais">
                <div onclick="abrir_individuais()" id="div_barra_individual" class="barra_individuais"><h2>Informações individuais:</h2> <img class="seta" src="imagens/seta_direita_clara.png" alt=""></div>
                <div onclick="fechar_individuais()" id="div_barra_individual_opn" style="display: none;" class="barra_individuais"><h2>Informações individuais:</h2> <img class="seta" src="imagens/seta_baixo_clara.png" alt=""></div> 
                <div id="info_individuais" class="indivs">
                    <h1>Gráfico dos acertos e erros totais de <span id="nome_usuario"></span>:</h1>
                    <canvas class="graficos" style="background-color: white;" id="grafico_erro_acerto_indiv"></canvas>
                    <br>
                    <br>
                    <h1></h1>

                </div>
                </div>

                <br>

                <div id="div_geral" class="pnts_geral">
                    <div onclick="abrir_gerais()" id="div_barra_geral" class="barra_individuais"><h2>Informações gerais:</h2> <img class="seta" src="imagens/seta_direita_clara.png" alt=""></div>
                    <div onclick="fechar_gerais()" id="div_barra_geral_opn" style="display: none;" class="barra_individuais"><h2>informações gerais:</h2> <img class="seta" src="imagens/seta_baixo_clara.png" alt=""></div> 
                    <div id="info_individuais" class="indivs">
                        <h1>Gráfico de favoritismo de personagens:</h1>
                        <canvas class="grafico_pie" id="grafico_personagens"></canvas>
                        <div id="div_maiormenor">
                            <div id="maior"><span id="span_maior"></span></div>
                            <div id="menor"><span id="span_menor"></span></div>
                        </div>
                    </div>

                    <div id="info_gerais" class="indivs">
                        <h1>Gráfico dos acertos e erros gerais:</h1>
                        <canvas class="graficos" id="grafico_erro_acerto_indiv"></canvas>
    
                    </div>

        </div>
        
        </div>

    </div>
    
</body>
</html>

<script>
    var nome_user = sessionStorage.NOME_USUARIO;
    var id_user = sessionStorage.ID_USUARIO;

    nome_usuario.innerHTML = nome_user

    function abrir_individuais(){
        document.getElementById("div_barra_individual").style.display = "none";
        document.getElementById("div_barra_individual_opn").style.display = "flex";
        document.getElementById("info_individuais").style.display = "flex";
    }

    function fechar_individuais(){
        document.getElementById("div_barra_individual").style.display = "flex";
        document.getElementById("div_barra_individual_opn").style.display = "none";
        document.getElementById("info_individuais").style.display = "none";
    }

    function abrir_gerais(){
        document.getElementById("div_barra_geral").style.display = "none";
        document.getElementById("div_barra_geral_opn").style.display = "flex";
        document.getElementById("info_gerais").style.display = "flex";
    }

    function fechar_gerais(){
        document.getElementById("div_barra_individual").style.display = "flex";
        document.getElementById("div_barra_individual_opn").style.display = "none";
        document.getElementById("info_gerais").style.display = "none";
    }


    // grafico erros e acertos inividuais


// PARTE DIFICIL -CONSEGUIR OS DADOS PRA DASH

// O gráfico é construído com três funções:
    // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
    // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
    // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

    // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
    // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
    // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    var fk_usuario = sessionStorage.ID_USUARIO
console.log(`${fk_usuario}`);

        window.onload = function() {
        obterDadosGrafico();
        buscarMaiorMenorPontuacao();
    };

    function buscarPersonagens(){

}

    function buscarMaiorMenorPontuacao(){

        var fk_usuario = sessionStorage.ID_USUARIO
var maior; 
var menor;  

fetch(`/medidas/ultimas/${fk_usuario}`, { cache: 'no-store' })
            .then(response => response.json())
            .then(data => {
                console.log('Dados recebidos:', data);

                if (data) {
                    var maior = data.map(item => item.maior_acerto);
                    var menor = data.map(item => item.menor_acerto);
                    console.log('Maior acerto:', maior);
                    console.log('Menor acerto:', menor);

                    document.getElementById('span_maior').innerText = `Maior acerto: ${maior}`;
                    document.getElementById('span_menor').innerText = `Menor acerto: ${menor}`;
                } else {
                    console.error('Dados retornados são inválidos:', data);
                }
            })
            .catch(error => console.error('Falha na captura de maior e menor nota', error));
    }



    function obterDadosGrafico() {
""
var fk_usuario = sessionStorage.ID_USUARIO
console.log(`${fk_usuario}`);

var corretas; 
var erradas;   

fetch(`/medidas/ultimas/${fk_usuario}`, { cache: 'no-store' })
    .then(response => response.json())
    .then(data => {
        console.log(data);

        // Atribuição das variáveis dentro do callback
        corretas = data.map(item => item.acertos);
        erradas = data.map(item => item.erros);
        console.log(corretas);
        console.log(erradas);

        var ctx = document.getElementById('grafico_erro_acerto_indiv').getContext('2d');

        const labels = [
        "Acertos e erros",
    ];

    

    const charData = {
  labels: ['Acertos','Erros'],
  datasets: [
    {
      label: 'Dataset 1',
      data: [corretas, erradas],
      backgroundColor: ['red','#14C310'],
    }
  ]
};
    
        var config = {
            type: 'pie',
            data: charData,
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        };

        new Chart(ctx, config);

        console.log(data)
    }).catch(error => console.error('Falha na captura de acertos', error))
}



</script>