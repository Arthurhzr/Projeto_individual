<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pontuações</title>
    <link rel="stylesheet" href="css/stylegeral.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/sessao.js" ></script>
    <script src="./../js/alerta.js"></script>
</head>
<body class="body_dash">

    <header>
        <div class="container">
            <div class="logo">
                <a href=""><img src="imagens/X_All-Logo.png" class="imagemLogo"></a>
            </div>
            <div class="menu">
                <nav>
                    <ul>
                        <li><a href="index.html"><b>Página Inicial</b></a></li>
                        <li class="agora"><a><b>Pontuações</b></a></li>
                        <li><a href="login.html"><b>Entrar</b></a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div id="div_conteudo_dash" class="div_conteudo2">

        <div id="div_centro" class="centro_dash">
            <div id="btn_sair"></div>
            <h1>Bem vindo as estatísticas do quiz!</h1> <h1>Aqui você pode ver acertos e erros tanto individuais como gerais</h1>

            <div id="div_individual" class="pnts_individuais">
                <div onclick="abrir_individuais()" id="div_barra_individual" class="barra_individuais"><h2>Informações individuais:</h2> <img class="seta" src="imagens/seta_direita_clara.png" alt=""></div>
                <div onclick="fechar_individuais()" id="div_barra_individual_opn" style="display: none;" class="barra_individuais"><h2>Informações individuais:</h2> <img class="seta" src="imagens/seta_baixo_clara.png" alt=""></div> 
                <div id="info_individuais" class="indivs">
                    <h1>Gráfico dos seus acertos e erros totais:</h1>
                    <canvas class="graficos" style="background-color: white;" id="grafico_erro_acerto_indiv"></canvas>

                </div>

                <br>

                <div id="div_individual" class="pnts_individuais">
                    <div onclick="abrir_individuais()" id="div_barra_individual" class="barra_individuais"><h2>Informações gerais:</h2> <img class="seta" src="imagens/seta_direita_clara.png" alt=""></div>
                    <div onclick="fechar_individuais()" id="div_barra_individual_opn" style="display: none;" class="barra_individuais"><h2>informações gerais:</h2> <img class="seta" src="imagens/seta_baixo_clara.png" alt=""></div> 
                    <div id="info_individuais" class="indivs">
                        <h1>Gráfico de favoritismo de personagens:</h1>
                        <canvas class="graficos" id="grafico_personagens"></canvas>
    
                    </div>

                    <div id="info_individuais" class="indivs">
                        <h1>Gráfico dos acertos e erros gerais:</h1>
                        <canvas class="graficos" id="grafico_erro_acerto_indiv"></canvas>
    
                    </div>

        </div>
        
        </div>

    </div>
    
</body>
</html>

<script>

    var id_user = sessionStorage.ID_USUARIO;

    function abrir_individuais(){
        document.getElementById("div_barra_individual").style.display = "none";
        document.getElementById("div_barra_individual_opn").style.display = "flex";
        document.getElementById("info_individuais").style.display = "flex";
    }

    function fechar_individuais(){
        document.getElementById("div_barra_individual").style.display = "flex";
        document.getElementById("div_barra_individual_opn").style.display = "none";
        document.getElementById("info_individuais").style.display = "none";
    }


    // grafico erros e acertos inividuais

    const DATA_COUNT = 5;
const NUMBER_CFG = {count: DATA_COUNT, min: 0, max: 100};

const data = {
  labels: [
    'Erros',
    'Acertos'
  ],
  datasets: [{
    label: 'My First Dataset',
    data: [300, 100],
    backgroundColor: [
      'rgb(255, 99, 132)',
      'rgb(54, 162, 235)'
    ]
  }]
};

const config = {
  type: 'pie',
  data: data,
  options: {
    responsive: true,
    plugins: {
      legend: {
        position: 'top',
      },
      title: {
        display: true,
        text: 'Chart.js Pie Chart'
      }
    }
  },
};

/* const canvas_mychart = new Chart(
        document.getElementById('grafico_erro_acerto_ind'),
        config
    ); */
 



// PARTE DIFICIL -CONSEGUIR OS DADOS PRA DASH

// O gráfico é construído com três funções:
    // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
    // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
    // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

    // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
    // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
    // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    var fk_usuario = sessionStorage.ID_USUARIO
console.log(`${fk_usuario}`);

    window.onload = obterDadosGrafico(); 
    function obterDadosGrafico() {

var fk_usuario = sessionStorage.ID_USUARIO
console.log(`${fk_usuario}`);

fetch(`/medidas/ultimas/${fk_usuario}`, { cache: 'no-store' })
    .then(respose => respose.json())
    .then(data => {
        console.log(data)

        var ctx = document.getElementById('grafico_erro_acerto_indiv').getContext('2d')

        var acertos = data.map(item => item.acertos)
        var erros = data.map(item => item.erros)

        const labels = [
        "Acertos e erros",
    ];

    

    const charData = {
  labels: ['Corretas', 'Erradas'],
  datasets: [
    {
      label: 'Dataset 1',
      data: [acertos, erros],
      backgroundColor: '#fff',
    }
  ]
};
        var config = {
            type: 'bar',
            data: charData,
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        };

        new Chart(ctx, config);

        console.log(data)
    }).catch(error => console.error('Falha na captura de acertos', error))
}

// Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
// Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
// A função *plotarGrafico* também invoca a função *atualizarGrafico*
// function plotarGrafico(resposta, fk_usuario) {

// console.log('iniciando plotagem do gráfico...');

// // Criando estrutura para plotar gráfico - labels
// let labels = [];

// // Criando estrutura para plotar gráfico - dados
// let dados = {
//     labels: ['Acertos', 'Erros'],
//     datasets: [{
//         label: 'Acertos',
//         data: [],
//         fill: false,
//         borderColor: 'rgb(75, 192, 192)',
//         tension: 0.1
//     },
//     {
//         label: 'Erros',
//         data: [],
//         fill: false,
//         borderColor: 'rgb(199, 52, 52)',
//         tension: 0.1
//     }]
// };

// console.log('----------------------------------------------')
// console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
// console.log(resposta)

// // Inserindo valores recebidos em estrutura para plotar o gráfico
// for (i = 0; i < resposta.length; i++) {
//     var registro = resposta[i];
//     dados.datasets[0].data.push(pontuacao.acertos);
//     dados.datasets[1].data.push(pontuacao.erros);
// }

// console.log('----------------------------------------------')
// console.log('O gráfico será plotado com os respectivos valores:')
// console.log('Labels:')
// console.log(labels)
// console.log('Dados:')
// console.log(dados.datasets)
// console.log('----------------------------------------------')

// // Criando estrutura para plotar gráfico - config
// const config = {
//     type: 'bar',
//     data: dados,
// };

// // Adicionando gráfico criado em div na tela
// let myChart = new Chart(
//     document.getElementById(`grafico_erro_acerto_indiv`),
//     config
// );

// setTimeout(() => atualizarGrafico(idusuario, dados, myChart), 2000);
// }


// // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
// // buscando a última medida inserida em tabela contendo as capturas, 

// //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
// //     Para ajustar o "select", ajuste o comando sql em src/models
// function atualizarGrafico(idusuario, dados, myChart) {



// fetch(`/medidas/tempo-real/${idusuario}`, { cache: 'no-store' }).then(function (response) {
//     if (response.ok) {
//         response.json().then(function (novoRegistro) {

//             obterdados(idusuario);
//             // alertar(novoRegistro, idusuario);
//             console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
//             console.log(`Dados atuais do gráfico:`);
//             console.log(dados);

//             let avisoCaptura = document.getElementById(`avisoCaptura${idusuario}`)
//             avisoCaptura.innerHTML = ""


//             if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
//                 console.log("---------------------------------------------------------------")
//                 console.log("Como não há dados novos para captura, o gráfico não atualizará.")
//                 avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
//                 console.log("Horário do novo dado capturado:")
//                 console.log(novoRegistro[0].momento_grafico)
//                 console.log("Horário do último dado capturado:")
//                 console.log(dados.labels[dados.labels.length - 1])
//                 console.log("---------------------------------------------------------------")
//             } else {
//                 // tirando e colocando valores no gráfico
//                 dados.labels.shift(); // apagar o primeiro
//                 dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

//                 dados.datasets[0].data.shift();  // apagar o primeiro de umidade
//                 dados.datasets[0].data.push(novoRegistro[0].acertos); // incluir uma nova medida de umidade

//                 dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
//                 dados.datasets[1].data.push(novoRegistro[0].erros); // incluir uma nova medida de temperatura

//                 myChart.update();
//             }

//             // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
//             proximaAtualizacao = setTimeout(() => atualizarGrafico(fk_usuario, dados, myChart), 2000);
//         });
//     } else {
//         console.error('Nenhum dado encontrado ou erro na API');
//         // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
//         proximaAtualizacao = setTimeout(() => atualizarGrafico(fk_usuario, dados, myChart), 2000);
//     }
// })
//     .catch(function (error) {
//         console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
//     });

// }







</script>